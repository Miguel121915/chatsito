<!DOCTYPE html>
<html>
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width">
 <title>Chatsito</title>
 <style>
  body {
   font-family: Arial, sans-serif;
   max-width: 600px;
   margin: 50px auto;
   padding: 20px;
   background-color: #f5f5f5;
  }
  form {
   background: white;
   padding: 30px;
   border-radius: 10px;
   box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  h1 {
   color: #0f0e0e;
   text-align: center;
  }
  label {
   display: block;
   margin-bottom: 5px;
   color: #582c2c;
   font-weight: bold;
  }
  input {
   width: 100%;
   padding: 10px;
   margin-bottom: 15px;
   border: 1px solid #ddd;
   border-radius: 5px;
   box-sizing: border-box;
   font-size: 14px;
  }
  button {
   width: 100%;
   padding: 12px;
   background-color: #b1008e;
   color: white;
   border: none;
   border-radius: 5px;
   font-size: 16px;
   cursor: pointer;
   font-weight: bold;
  }
  button:hover {
   background-color: #b30000;
  }
  #pre {
   background-color: #f8f9fa;
   padding: 15px;
   border-radius: 5px;
   border: 1px solid #ddd;
   max-height: 300px;
   overflow-y: auto;
   white-space: pre-wrap;
   word-wrap: break-word;
   margin-top: 20px;
  }
  .obligatorio {
   color: #dc3545;
   font-size: 12px;
  }
  .estado-conectado {
   color: #6300f7;
   font-weight: bold;
  }
  .estado-error {
   color: #dc3545;
   font-weight: bold;
  }
 </style>
 <!-- Librería Paho MQTT desde CDN -->
 <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
</head>
<body>
 <form id="formulario">
  <h1> Chatsito</h1>
  <p>
   <label>
    Alias *
    <input id="inputAlias" required placeholder="Tu nombre o apodo">
   </label>
  </p>
  <p>
   <label>
    Mensaje *
    <input id="inputMensaje" required placeholder="Escribe tu mensaje">
   </label>
  </p>
  <p class="obligatorio">* Obligatorio</p>
  <p><button type="submit">Enviar</button></p>
  <pre id="pre">Conectando…</pre>
 </form>

 <script type="module">
  const TOPICO_CHAT = "gilpgawoas/chat"
  
  // Crear ID único para el cliente
  function creaIdCliente(prefijo) {
   const timestamp = Date.now()
   const random = Math.random().toString(36).substring(2, 15)
   return `${prefijo}${timestamp}-${random}`
  }

  const clientId = creaIdCliente("gilpgawoasChat-")
  
  // Crear cliente MQTT
  const cliente = new Paho.MQTT.Client("test.mosquitto.org", 8081, clientId)

  // Función para enviar mensaje
  function enviaMensajeMqtt(cliente, mensaje, topico) {
   try {
    const mensajeMqtt = new Paho.MQTT.Message(mensaje)
    mensajeMqtt.destinationName = topico
    cliente.send(mensajeMqtt)
    console.log("Mensaje enviado:", mensaje)
    
    // Limpiar el campo de mensaje después de enviar
    inputMensaje.value = ""
   } catch (error) {
    console.error("Error al enviar mensaje:", error)
    alert("Error al enviar el mensaje. Por favor, intenta de nuevo.")
   }
  }

  // Manejar envío del formulario
  function submit(event) {
   event.preventDefault()
   const mensaje = `${inputAlias.value.trim()}
${inputMensaje.value.trim()}`
   enviaMensajeMqtt(cliente, mensaje, TOPICO_CHAT)
  }

  // Acciones al recibir un mensaje
  cliente.onMessageArrived = mensaje => {
   if (mensaje.destinationName === TOPICO_CHAT) {
    pre.textContent += mensaje.payloadString + "\n\n"
    // Auto-scroll hacia abajo
    pre.scrollTop = pre.scrollHeight
   }
  }

  // Acciones al perder la conexión
  cliente.onConnectionLost = respuesta => {
   if (respuesta.errorCode !== 0) {
    console.error("Conexión MQTT perdida:", respuesta.errorMessage)
    pre.textContent += "\n\n Conexión perdida. Recarga la página.\n\n"
    pre.className = "estado-error"
   }
  }

  // Conectar al servidor MQTT
  cliente.connect({
   keepAliveInterval: 10,
   useSSL: true,
   onFailure: (respuesta) => {
    console.error("Fallo en la conexión MQTT:", respuesta)
    alert("No se pudo conectar al servidor MQTT. Por favor, intenta de nuevo más tarde.")
    pre.textContent = "xc Error: No se pudo conectar al servidor.\n\n"
    pre.className = "estado-error"
   },
   onSuccess: () => {
    console.log("Conectado.")
    pre.textContent = "xD Conectado al chat.\n\n"
    pre.className = "estado-conectado"
    // Suscribirse al tópico
    cliente.subscribe(TOPICO_CHAT)
    formulario.addEventListener("submit", submit)
   },
  })

  // Manejo de errores global
  window.addEventListener("error", (event) => {
   console.error("Error:", event.error)
  })

  window.addEventListener("unhandledrejection", (event) => {
   console.error("Error en promesa:", event.reason)
  })
 </script>
</body>
</html>
